"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(e){function t(i,n){this.$element=e(i),this.options=e.extend({},t.DEFAULTS,e.isPlainObject(n)&&n),this.init()}var i=e("body"),n=e(document),a="qor.medialibrary.select",o="qor.bottomsheets",s="click."+a,r="enable."+a,d="disable."+a,l="reload."+o,c=".qor-select__select-icon",h=".qor-selectmany__hint",m=".qor-field__mediabox",f=".qor-field__mediabox-list",u=".qor-field__mediabox-item",p=".qor-field__mediabox-data",y=".qor-bottomsheets",b="is_selected",g="is_deleted",_="textarea.qor-file__options",S=".qor-cropper__toggle--delete",v=".qor-cropper__toggle--undo",D="qor-bottomsheets__mediabox";return t.prototype={constructor:t,init:function(){var e=this.$element;this.SELECT_MEDIABOX_UNDO_TEMPLATE=e.find('[name="media-box-undo-delete"]').html(),this.bind(),this.initSelectedMedia()},bind:function(){n.on(s,"[data-mediabox-url]",this.openBottomSheets.bind(this)).on(l,"."+D,this.reloadData.bind(this)),this.$element.on(s,S,this.deleteSelected.bind(this)).on(s,v,this.undoDeleteSelected.bind(this)).on("change.qor.cropper",_,this.imageCrop.bind(this))},deleteSelected:function(t){var i=e(t.target),n=i.closest(u);return n.addClass(g).append(this.SELECT_MEDIABOX_UNDO_TEMPLATE).find(".qor-file__list").hide(),this.updateMediaLibraryData(i.closest(f)),this.$element.find(p).data("isDeleted",!0),!1},undoDeleteSelected:function(t){var i=e(t.target),n=i.closest(u);return n.removeClass(g).find(".qor-file__list").show(),this.updateMediaLibraryData(i.closest(f)),i.closest(".qor-fieldset__alert").remove(),this.$element.find(p).data("isDeleted",!1),!1},imageCrop:function(t){var i=e(t.target).closest(u);this.syncImageCrop(i)},openBottomSheets:function(t){var n,a=e(t.target).closest("[data-mediabox-url]"),o=a.data();o.isDisabled||(this.BottomSheets=i.data("qor.bottomsheets"),this.bottomsheetsData=o,this.$parent=n=a.closest(m),this.$selectFeild=n.find(f),o.url=o.mediaboxUrl,this.SELECT_MANY_SELECTED_ICON=e('[name="select-many-selected-icon"]').html(),this.SELECT_MANY_HINT=e('[name="select-many-hint"]').html(),this.SELECT_MEDIABOX_TEMPLATE=n.find('[name="media-box-template"]').html(),this.SELECT_MEDIABOX_UNDO_TEMPLATE=n.find('[name="media-box-undo-delete"]').html(),this.BottomSheets.open(o,this.handleSelectMany.bind(this)))},initSelectedMedia:function(){var e,t,i=this.$element,n=i.find(u),a=JSON.parse(i.find(p).val());if(a)for(var o=0;o<a.length;o++)e=n.filter('[data-primary-key="'+a[o].ID+'"]'),t=e.data().description,t||e.data("description",a[o].Description)},initMedia:function(){var t,i,n,a=this.$selectFeild,o=a.find(u).not("."+g),s=e(y).find("tbody tr"),r=this;o.each(function(){n=e(this).data().primaryKey,t=s.filter('[data-primary-key="'+n+'"]').addClass(b),r.changeIcon(t,!0)}),s.each(function(){t=e(this),i=t.find(".qor-table--ml-slideout p img").first(),t.find(".qor-table__actions").remove(),i.length&&(t.find(".qor-table--medialibrary-item").css("background-image","url("+i.prop("src")+")"),i.parent().remove())}),"1"!=this.bottomsheetsData.maxItem&&this.updateHint(this.getSelectedItemData())},reloadData:function(){this.$selectFeild&&this.initMedia()},renderSelectMany:function(e){return window.Mustache.render(this.SELECT_MEDIABOX_TEMPLATE,e)},renderHint:function(e){return window.Mustache.render(this.SELECT_MANY_HINT,e)},getSelectedItemData:function(t){var i,n=t?t:this.$selectFeild,a=n.find(u).not("."+g),o=[];return a.size()&&a.each(function(){i=e(this).data(),o.push({ID:i.primaryKey,Url:i.originalUrl.replace(/.original.(\w+)$/,".$1"),Description:i.description})}),{files:o,selectedNum:o.length}},updateHint:function(t){var i;e.extend(t,this.bottomsheetsData),i=this.renderHint(t),e(h).remove(),e(y).find(".qor-page__body").before(i)},updateMediaLibraryData:function(e,t){var i=e?e.find(p):this.$selectFeild.find(p),n=this.getSelectedItemData(e);i.val(JSON.stringify(n.files)).data("mediaData",t).trigger("changed.medialibrary",[t])},changeIcon:function(t,i){var n=t.find(".qor-table--medialibrary-item"),a=n.size()?n:t.find("td:first");t.find(c).remove(),i&&("one"==i&&e("."+D).find(c).remove(),a.prepend(this.SELECT_MANY_SELECTED_ICON))},syncImageCrop:function(t,i){var n,a,o=JSON.parse(t.find(_).val()),s=t.data().mediaLibraryUrl,r={},d=["Width","Height"],l=t.find("img[data-size-name]");delete o.ID,delete o.Url,o.Sizes={},l.each(function(){a=e(this).data(),o.Sizes[a.sizeName]={};for(var t=0;t<d.length;t++)n=a["sizeResolution"+d[t]],n||(n=a.sizeResolution[d[t]]),o.Sizes[a.sizeName][d[t]]=n}),r.MediaOption=JSON.stringify(o),e.ajax({type:"PUT",url:s,data:JSON.stringify(r),contentType:"application/json",dataType:"json",success:function(n){r.MediaOption=JSON.parse(n.MediaOption),i&&e.isFunction(i)&&i(r,t)}})},showHiddenItem:function(e){e.removeClass(g).find(".qor-file__list").show(),e.find(".qor-fieldset__alert").remove()},removeItem:function(e){var t=e.primaryKey;this.$selectFeild.find('[data-primary-key="'+t+'"]').remove(),this.changeIcon(e.$clickElement)},compareCropSizes:function(e){var t,i,n=e.MediaOption.CropOptions,a=this.bottomsheetsData.cropSizes;if(!a)return!1;if(a=a.split(","),t=a.length-1,!window._.isObject(n))return!1;if(i=Object.keys(n),i.length)for(var o=0;o<t;o++)if(i.indexOf(a[o])==-1)return!0;return!1},addItem:function(t,i){var n=e(this.renderSelectMany(t)),a=n.find(".qor-file__input"),o=a.closest(u),s=this.$selectFeild.find('[data-primary-key="'+t.primaryKey+'"]'),r=this.bottomsheetsData.maxItem,d=this.getSelectedItemData().selectedNum,l=t.MediaOption.CropOptions,c=this.compareCropSizes(t),h=this;if(i||(1==r?this.changeIcon(t.$clickElement,"one"):this.changeIcon(t.$clickElement,!0)),r&&d>=r){if(1!=r)return void window.alert(this.bottomsheetsData.maxItemHint);this.$selectFeild.find(u).remove()}return s.size()?(this.showHiddenItem(s),void(1==r&&setTimeout(function(){h.BottomSheets.hide()},1e3))):(1==r&&this.$selectFeild.find(u).filter(".is_deleted").remove(),n.data({description:t.MediaOption.Description,mediaData:t}),n.appendTo(this.$selectFeild),l&&this.resetImages(t,n),n.find(_).val(JSON.stringify(t.MediaOption)),n.trigger("enable"),l&&!c||a.data("qor.cropper").load(t.MediaOption.URL,function(){h.syncImageCrop(o,h.resetImages)}),void((i||1==r)&&setTimeout(function(){h.BottomSheets.hide()},150)))},resetImages:function(t,i){var n=t.MediaOption.CropOptions,a=Object.keys(n),o=t.MediaOption.OriginalURL;if(/original/.test(o)){for(var s=a.length-1;s>=0;s--)n[a[s]].URL=o.replace(/original/,a[s]);i.find("img").each(function(){var t=e(this),i=t.data().sizeName;i&&"original"!=i&&n[i]&&t.prop("src",n[i].URL)})}},handleSelectMany:function(){var t=e(y),i={onSelect:this.onSelectResults.bind(this),onSubmit:this.onSubmitResults.bind(this)};t.qorSelectCore(i).addClass(D),this.initMedia()},onSelectResults:function(e){this.handleResults(e)},onSubmitResults:function(e){this.handleResults(e,!0)},handleResults:function(e,t){t?(e.MediaOption=JSON.parse(e.MediaOption),this.handleResultsData(e,t)):this.handleResultsData(e)},handleResultsData:function(e,t){var i,n=e.$clickElement;return e.mediaLibraryUrl||t||(e.mediaLibraryUrl=e.url),t?(e.mediaLibraryUrl=this.bottomsheetsData.mediaboxUrl+"/"+e.primaryKey,this.addItem(e,t),void this.updateDatas(e)):(n.toggleClass(b),i=n.hasClass(b),i?this.addItem(e):this.removeItem(e),void this.updateDatas(e))},updateDatas:function(e){"1"!=this.bottomsheetsData.maxItem&&this.updateHint(this.getSelectedItemData()),this.updateMediaLibraryData(null,e)}},t.plugin=function(i){return this.each(function(){var n,o=e(this),s=o.data(a);if(!s){if(/destroy/.test(i))return;o.data(a,s=new t(this,i))}"string"==typeof i&&e.isFunction(n=s[i])&&n.apply(s)})},e(function(){var i='[data-toggle="qor.mediabox"]';e(document).on(d,function(n){t.plugin.call(e(i,n.target),"destroy")}).on(r,function(n){t.plugin.call(e(i,n.target))}).triggerHandler(r)}),t});